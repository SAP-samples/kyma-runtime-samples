# Overview

In this sample, we will start from scratch / zero to deploying an [CAP](https://cap.cloud.sap/docs/) NodeJS application on Kyma runtime.

![cap-bookshop](assets/cap-booksop.png)

- You will create a sample Node.JS based CAP application (Bookshop)
- Using cds, you will create the necessary artifacts and configurations required to deploy on Kyma.
- Last, but not least, you will deploy and verify your running CAP application on SAP BTP, Kyma runtime.

> Note: For simplification most of the commands have been defined using the [Makefile](Makefile). In case you want to understand what the actual command is, run `make <command> --just-print`

## Prerequisites

- [SAP BTP, Kyma runtime instance](../prerequisites/README.md#kyma)
- [Docker](../prerequisites/README.md#docker)
- [make](https://www.gnu.org/software/make/)
- [Kubernetes tooling](../prerequisites/README.md#kubernetes)
- [Pack](../prerequisites/README.md#pack)
- [NodeJS 20 or higher](https://nodejs.org/en/download/)
- [SAP CAP](../prerequisites/README.md#sap-cap)
- SAP Hana Cloud Instance
- [SAP Hana Cloud Instance mapped to Kyma](https://blogs.sap.com/2022/12/15/consuming-sap-hana-cloud-from-the-kyma-environment/)

## CAP Application

- Initialize the Cap Bookshop sample

```shell
make init
```

Let's take a minute to inspect our cap application. It is a simple Bookshop sample where you can access Book entries via API calls.

- Data model defined in [./bookshop/db/schema.cds](./bookshop/db/schema.cds) <!-- markdown-link-check-disable-line -->
- Core Data Service defined in [./bookshop/srv/cat-service.cds](./bookshop/srv/cat-service.cds) <!-- markdown-link-check-disable-line -->

Directly from CAP website, *CAP promotes getting started with minimal upfront setup, based on convention over configuration, and a grow-as-you-go approach, adding settings and tools later on, only when you need them.*

- Run the application locally

```shell
make run-local
```

- Access the CAP Srv at <http://localhost:4004>
- Terminate the local running app with `^C`

## Deploy to Kyma

### Add default route for App router

- Update the [bookshop/app/router/xs-app.json](bookshop/app/router/xs-app.json) <!-- markdown-link-check-disable-line -->
  to add a default route for the app router. This is required to access the CAP application via the URL. The end json should look as below:

```json
{
  "welcomeFile": "/odata/v4/catalog/Books",
  "routes": [
    {
      "source": "^/(.*)$",
      "target": "$1",
      "destination": "srv-api",
      "csrfProtection": true
    }
  ]
}
```

> Note: The standalone approuter is being used for a simpler sample and **is not a must**. It should be possible to use the managed approuter as well as have you CAP APIs being exposed via Fiori or UI5 applications and accessed using workzone.

### Configure environment variables

- Set up required environment variables

  - In shell

    ```shell
    export KUBECONFIG=<your-kubeconfig-file-path>
    export NAMESPACE=<your-kyma-namespace>
    ```

  - In Windows powershell

    ```powershell
    $ENV:KUBECONFIG="<your-kubeconfig-file-path>"
    $ENV:NAMESPACE="<your-kyma-namespace>"
    ```

- For mac users, export the DOCKER_HOST

```shell
export DOCKER_HOST=unix://${HOME}/.docker/run/docker.sock
```

### Prepare for deployment

Let's do a bit of groundwork before we deploy our Helm Chart. In Kyma/Kubernetes, the workloads and required configurations will be deployed in namespaces.

- We will create a namespace. You can skip this step if you already have a namespace

```shell
make create-namespace
```

- Now let's enable Istio injection for the namespace. Set the kubeconfig context to point to the namespace and create the docker image pull secret.

```shell
make prepare-kyma-for-deployment
```

### Create Helm chart

Now that we have our artifacts in place, lets shift our focus to deploying the application.

First we need the configurations to tell Kyma what and how we want to deploy.

We will use [Helm Charts](https://helm.sh/) to define  the required configurations and then deploy them on Kyma runtime.

`cds` can intelligently inspect what all is defined in your cap application and generate the necessary configurations (Helm charts) to deploy it on Kyma runtime.

- Create Helm chart

```shell
make create-helm-chart
```

Now take a moment to understand the generated Helm chart in the [chart](./bookshop/chart) directory. <!-- markdown-link-check-disable-line -->

Helm chart Structure will look as below. The full helm chart will be automatically generated by `cds` under `gen` folder.
![helm-chart](assets/helm-chart-structure.png)

- [bookshop/chart/Chart.yaml](bookshop/chart/Chart.yaml) contains the details about the chart and all its dependencies. <!-- markdown-link-check-disable-line -->
- [bookshop/chart/values.yaml](bookshop/chart/values.yaml) <!-- markdown-link-check-disable-line --> contains all the details to configure the chart deployment. You will notice that it has sections for `hana deployer`, `cap application` as well as required `service instances` and `service bindings`

- Add Istio destination rule for approuter. Please check the [approuter documentation](https://www.npmjs.com/package/@sap/approuter) for details about `PLATFORM_COOKIE_NAME` configuration.

```shell
make add-istio-destination-rule
```

- Update the [bookshop/chart/values.yaml](bookshop/chart/values.yaml) <!-- markdown-link-check-disable-line -->
  to add the environment variables for the **approuter section** that is used for cookie.

```yaml
  health:
    liveness:
      path: /
    readiness:
      path: /
  env:
    PLATFORM_COOKIE_NAME: KYMA_APP_SESSION_ID # This is the cookie name used by the approuter to store session information
```

### Build and deploy

- Add containerize

```shell
make add-containerize
```

- Build and deploy to Kyma runtime

```shell
make cds-build-deploy
```

### Verify your deployment

- Access the application via the app router URL. It will be of the form <https://bookshop-approuter-${NAMESPACE}.${KYMA_CLUSTER_DOMAIN}>

### Cleanup

- Delete the helm chart. This will delete the helm chart. Thereby all deployed applications, service instances and their bindings will be cleaned.

```shell
make undeploy
```

- Remove the namespace and bookshop cap application folder

```shell
make cleanup
```

## Detailed Path

For following the detailed path where you build the artifacts and deploy them step by step, please refer to [the detailed path](./the-detailed-path.md).

## CAP Version

Latest verified on following CAP version.

| bookshop               | "Add your repository here" |
|------------------------|----------------------------|
| @cap-js/asyncapi       | 1.0.3                      |
| @cap-js/openapi        | 1.2.2                      |
| @sap/cds               | 8.9.4                      |
| @sap/cds-compiler      | 5.9.2                      |
| @sap/cds-dk (global)   | 8.9.4                      |
| @sap/cds-fiori         | 1.4.1                      |
| @sap/cds-foss          | 5.0.1                      |
| @sap/cds-mtxs          | 2.7.2                      |
| @sap/eslint-plugin-cds | 3.2.0                      |
| Node.js                | v22.11.0                   |

## Takeaway

*CAP supports grow-as-you-go model. Once you have familiarized yourself with CAP basics, you can go further and add capabilities such as authentication, multitenancy, extensibility, messaging and many more.*

You can explore CAP further on <https://cap.cloud.sap/docs/>
